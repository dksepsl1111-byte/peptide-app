<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>펩타이드 트래커</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } = Recharts;
        const { Calendar, TrendingDown, Syringe, Package, Plus, Trash2, Clock } = lucide;

        const PEPTIDES = {
            mounjaro: { id: 'mounjaro', name: '마운자로', color: '#3b82f6', defaultCycle: 7, doses: [2.5, 5, 7.5, 10, 12.5, 15], vialSizes: [50, 60, 80] },
            tesamorelin: { id: 'tesamorelin', name: '테사모렐린', color: '#10b981', defaultCycle: 1, doses: [1, 2], vialSizes: [2, 5, 10] },
            retatrutide: { id: 'retatrutide', name: '레타트루타이드', color: '#f59e0b', defaultCycle: 7, doses: [1, 2, 3, 4, 5, 6, 7, 8], vialSizes: [10, 30] }
        };

        function App() {
            const [activeTab, setActiveTab] = useState('record');
            const [injections, setInjections] = useState([]);
            const [weights, setWeights] = useState([]);
            const [inventory, setInventory] = useState([]);
            const [cycles, setCycles] = useState({ mounjaro: 7, tesamorelin: 1, retatrutide: 7 });
            
            const [newInjection, setNewInjection] = useState({ date: new Date().toISOString().split('T')[0], peptide: 'mounjaro', dose: 2.5, vialId: '' });
            const [newWeight, setNewWeight] = useState({ date: new Date().toISOString().split('T')[0], weight: '' });

            useEffect(() => {
                const saved = localStorage.getItem('peptide_data');
                if (saved) {
                    const data = JSON.parse(saved);
                    setInjections(data.injections || []);
                    setWeights(data.weights || []);
                    setInventory(data.inventory || []);
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('peptide_data', JSON.stringify({ injections, weights, inventory }));
            }, [injections, weights, inventory]);

            // [cite: 29] 다음 주사 일정 계산 로직
            const getNextInjections = () => {
                const next = {};
                Object.keys(PEPTIDES).forEach(pid => {
                    const inj = injections.filter(i => i.peptide === pid);
                    if (inj.length === 0) return;
                    const last = inj[inj.length - 1];
                    const cycle = cycles[pid] || PEPTIDES[pid].defaultCycle;
                    const nextDate = new Date(last.date);
                    nextDate.setDate(nextDate.getDate() + cycle);
                    
                    const diffTime = nextDate - new Date();
                    const days = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    next[pid] = { date: nextDate, daysUntil: days, peptide: PEPTIDES[pid] };
                });
                return next;
            };

            const nextInjections = getNextInjections();

            const addVial = () => {
                const p = PEPTIDES[newInjection.peptide];
                const size = p.vialSizes[0];
                setInventory([...inventory, { id: Date.now(), peptide: p.id, totalSize: size, remaining: size, addedDate: new Date().toISOString().split('T')[0] }]);
                alert(`${p.name} 주사기 등록 완료!`);
            };

            const addInjection = () => {
                if (!newInjection.vialId) return alert('재고 탭에서 주사기를 먼저 등록/선택해주세요.');
                const vial = inventory.find(v => v.id === parseInt(newInjection.vialId));
                if (!vial || vial.remaining < newInjection.dose) return alert('용량이 부족합니다.');

                setInjections([...injections, { ...newInjection, id: Date.now() }].sort((a, b) => new Date(a.date) - new Date(b.date)));
                setInventory(inventory.map(v => v.id === vial.id ? { ...v, remaining: v.remaining - newInjection.dose } : v));
                alert('주사 기록 완료!');
            };

            return (
                <div className="max-w-md mx-auto min-h-screen flex flex-col pb-20">
                    <header className="p-6 bg-white shadow-sm flex items-center justify-between">
                        <div className="flex items-center gap-2">
                            <Syringe className="text-blue-500" size={24} />
                            <h1 className="text-xl font-bold">펩타이드 매니저</h1>
                        </div>
                    </header>

                    <main className="p-4 space-y-4">
                        {/* [cite: 35, 42] 알람 대시보드 */}
                        {Object.keys(nextInjections).length > 0 && (
                            <section className="space-y-2">
                                <h3 className="text-xs font-bold text-slate-400 px-1 uppercase tracking-wider">주사 알람</h3>
                                <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                                    {Object.values(nextInjections).map(({daysUntil, peptide}) => (
                                        <div key={peptide.id} className={`min-w-[140px] p-4 rounded-2xl shadow-sm border-b-4 ${daysUntil <= 0 ? 'bg-red-500 border-red-700 text-white' : 'bg-white border-blue-500'}`}>
                                            <p className={`text-[10px] font-bold ${daysUntil <= 0 ? 'text-red-100' : 'text-slate-400'}`}>{peptide.name}</p>
                                            <h2 className="text-lg font-black">{daysUntil <= 0 ? 'D-DAY' : `D-${daysUntil}`}</h2>
                                        </div>
                                    ))}
                                </div>
                            </section>
                        )}

                        {activeTab === 'record' && (
                            <div className="space-y-4">
                                <div className="bg-white p-5 rounded-3xl shadow-sm space-y-4">
                                    <div className="flex items-center gap-2 font-bold text-slate-700 border-b pb-2 text-sm">
                                        <Clock size={16}/> 기록하기
                                    </div>
                                    <input type="date" value={newInjection.date} onChange={e => setNewInjection({...newInjection, date: e.target.value})} className="w-full p-3 bg-slate-50 rounded-2xl border-none outline-blue-500 font-medium" />
                                    <select value={newInjection.peptide} onChange={e => setNewInjection({...newInjection, peptide: e.target.value, vialId: ''})} className="w-full p-3 bg-slate-50 rounded-2xl appearance-none font-medium">
                                        {Object.values(PEPTIDES).map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                                    </select>
                                    <select value={newInjection.vialId} onChange={e => setNewInjection({...newInjection, vialId: e.target.value})} className="w-full p-3 bg-slate-50 rounded-2xl appearance-none font-medium text-blue-600">
                                        <option value="">주사기 선택 (재고)</option>
                                        {inventory.filter(v => v.peptide === newInjection.peptide && v.remaining > 0).map(v => (
                                            <option key={v.id} value={v.id}>{v.remaining.toFixed(1)}mg 남음</option>
                                        ))}
                                    </select>
                                    <div className="flex gap-2 overflow-x-auto py-1 no-scrollbar">
                                        {PEPTIDES[newInjection.peptide].doses.map(d => (
                                            <button key={d} onClick={() => setNewInjection({...newInjection, dose: d})} className={`px-5 py-2 rounded-xl whitespace-nowrap text-sm font-bold transition-all ${newInjection.dose === d ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-400'}`}>{d}mg</button>
                                        ))}
                                    </div>
                                    <button onClick={addInjection} className="w-full bg-blue-600 text-white p-4 rounded-2xl font-bold shadow-xl shadow-blue-100 active:scale-95 transition-transform">기록 저장</button>
                                </div>

                                <div className="bg-white p-5 rounded-3xl shadow-sm space-y-3">
                                    <h3 className="font-bold text-slate-700 text-sm">체중 입력</h3>
                                    <div className="flex gap-2">
                                        <input type="number" placeholder="00.0" value={newWeight.weight} onChange={e => setNewWeight({...newWeight, weight: e.target.value})} className="flex-1 p-3 bg-slate-50 rounded-2xl border-none outline-green-500 font-bold" />
                                        <button onClick={() => { if(newWeight.weight) { setWeights([...weights, {...newWeight, id: Date.now()}].sort((a,b)=>new Date(a.date)-new Date(b.date))); setNewWeight({...newWeight, weight:''}); alert('체중 저장됨'); } }} className="bg-green-500 text-white px-6 rounded-2xl font-bold">저장</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'inventory' && (
                            <div className="space-y-4">
                                <button onClick={addVial} className="w-full p-5 bg-white border-2 border-dashed border-slate-200 rounded-3xl text-slate-400 font-bold hover:bg-slate-100 transition-colors">+ {PEPTIDES[newInjection.peptide].name} 주사기 추가</button>
                                {inventory.map(v => (
                                    <div key={v.id} className="bg-white p-5 rounded-3xl shadow-sm relative">
                                        <button onClick={() => setInventory(inventory.filter(i => i.id !== v.id))} className="absolute top-5 right-5 text-slate-200 hover:text-red-400"><Trash2 size={20}/></button>
                                        <div className="flex items-center gap-2 mb-3">
                                            <div className="w-3 h-3 rounded-full" style={{backgroundColor: PEPTIDES[v.peptide].color}}></div>
                                            <span className="font-black text-slate-700">{PEPTIDES[v.peptide].name}</span>
                                        </div>
                                        <div className="flex justify-between text-xs mb-2">
                                            <span className="text-slate-400 font-bold uppercase">Remaining</span>
                                            <span className="font-black text-slate-700">{v.remaining.toFixed(1)} / {v.totalSize}mg</span>
                                        </div>
                                        <div className="w-full bg-slate-100 h-3 rounded-full overflow-hidden">
                                            <div className="h-full transition-all duration-500" style={{width: `${(v.remaining/v.totalSize)*100}%`, backgroundColor: PEPTIDES[v.peptide].color}}></div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {activeTab === 'weight' && (
                            <div className="space-y-4">
                                <div className="bg-white p-8 rounded-[40px] shadow-sm text-center">
                                    <p className="text-slate-400 text-xs font-bold uppercase tracking-widest">Total Loss</p>
                                    <h2 className="text-5xl font-black text-blue-600 mt-2">
                                        {weights.length > 1 ? (weights[0].weight - weights[weights.length-1].weight).toFixed(1) : '0.0'}<span className="text-xl ml-1">kg</span>
                                    </h2>
                                </div>
                                <div className="h-64 bg-white p-4 rounded-3xl shadow-sm">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <LineChart data={weights}>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                            <XAxis dataKey="date" hide />
                                            <YAxis hide domain={['auto', 'auto']} />
                                            <Tooltip contentStyle={{borderRadius:'16px', border:'none', boxShadow:'0 10px 15px -3px rgba(0,0,0,0.1)'}} />
                                            <Line type="monotone" dataKey="weight" stroke="#3b82f6" strokeWidth={5} dot={{r: 6, fill: '#3b82f6', strokeWidth: 3, stroke: '#fff'}} activeDot={{r: 8}} />
                                        </LineChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                        )}
                    </main>

                    <nav className="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-lg border-t border-slate-100 flex justify-around p-3 max-w-md mx-auto rounded-t-[32px]">
                        <button onClick={() => setActiveTab('record')} className={`flex flex-col items-center gap-1 p-2 transition-all ${activeTab === 'record' ? 'text-blue-600 scale-110' : 'text-slate-300'}`}>
                            <Calendar size={24} strokeWidth={activeTab === 'record' ? 3 : 2} /><span className="text-[10px] font-black">기록</span>
                        </button>
                        <button onClick={() => setActiveTab('inventory')} className={`flex flex-col items-center gap-1 p-2 transition-all ${activeTab === 'inventory' ? 'text-blue-600 scale-110' : 'text-slate-300'}`}>
                            <Package size={24} strokeWidth={activeTab === 'inventory' ? 3 : 2} /><span className="text-[10px] font-black">재고</span>
                        </button>
                        <button onClick={() => setActiveTab('weight')} className={`flex flex-col items-center gap-1 p-2 transition-all ${activeTab === 'weight' ? 'text-blue-600 scale-110' : 'text-slate-300'}`}>
                            <TrendingDown size={24} strokeWidth={activeTab === 'weight' ? 3 : 2} /><span className="text-[10px] font-black">통계</span>
                        </button>
                    </nav>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
